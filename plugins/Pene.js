// ==========================
//  SISTEMA VERSUS 4 VS 4 (DiseÃ±o estilo captura)
// ==========================

let versusData = {} // Guarda el estado por mensaje

// --------------------------
// Comando .versus
// --------------------------
let handler = async (m, { conn }) => {
  const template = generarVersus([], []) // lista vacÃ­a
  const sent = await conn.sendMessage(m.chat, { text: template, mentions: [] })

  versusData[sent.key.id] = {
    chat: m.chat,
    escuadra: [],
    suplentes: []
  }
}
handler.command = /^versus$/i
export default handler

// --------------------------
// FunciÃ³n para generar mensaje con diseÃ±o nuevo
// --------------------------
function generarVersus(escuadra, suplentes) {
  return `    12 ğ•ğ„ğ‘ğ’ğ”ğ’ 12
    
    ğ‡ğğ‘ğ€ğ‘ğˆğ
    ğŸ‡²ğŸ‡½ ğŒğ„ğ— : ${horaUsuario}
    ğŸ‡¨ğŸ‡´ ğ‚ğğ‹ : ${horaAdelantada}
    ğ‚ğğ‹ğğ‘ ğƒğ„ ğ‘ğğğ€: ${colorRopa}

    Â¬ ğ‰ğ”ğ†ğ€ğƒğğ‘ğ„ğ’ ğğ‘ğ„ğ’ğ„ğğ“ğ„ğ’
    
          ğ—˜ğ—¦ğ—–ğ—¨ğ—”ğ——ğ—¥ğ—” 1
    
    ğŸ‘‘ â”‡ 
    ğŸ¥·ğŸ» â”‡  
    ğŸ¥·ğŸ» â”‡ 
    ğŸ¥·ğŸ» â”‡ 
          
         ğ—˜ğ—¦ğ—–ğ—¨ğ—”ğ——ğ—¥ğ—” 2
    
    ğŸ‘‘ â”‡ 
    ğŸ¥·ğŸ» â”‡ 
    ğŸ¥·ğŸ» â”‡ 
    ğŸ¥·ğŸ» â”‡ 
    
         ğ—˜ğ—¦ğ—–ğ—¨ğ—”ğ——ğ—¥ğ—” 3
    
    ğŸ‘‘ â”‡ 
    ğŸ¥·ğŸ» â”‡ 
    ğŸ¥·ğŸ» â”‡ 
    ğŸ¥·ğŸ» â”‡ 
    
    ã…¤Êš ğ’ğ”ğğ‹ğ„ğğ“ğ„:
    ğŸ¥·ğŸ» â”‡ 
    ğŸ¥·ğŸ» â”‡`
}

function formatSlots(arr, total, icon) {
  let out = ''
  for (let i = 0; i < total; i++) {
    if (arr[i]) out += `â”‚ ${icon} @${arr[i].split('@')[0]}\n`
    else out += `â”‚ ${icon} â¤\n`
  }
  return out.trim()
}

// --------------------------
// Listener de reacciones (ds6/meta)
// --------------------------
conn.ev.on('messages.upsert', async ({ messages }) => {
  for (let msg of messages) {
    if (!msg.message || !msg.message.reactionMessage) continue

    let msgID = msg.message.reactionMessage.key.id
    let data = versusData[msgID]
    if (!data) continue

    let user = msg.key.participant || msg.key.remoteJid
    let emoji = msg.message.reactionMessage.text

    data.escuadra = data.escuadra.filter(u => u !== user)
    data.suplentes = data.suplentes.filter(u => u !== user)

    if (emoji === 'â¤ï¸') {
      if (data.escuadra.length < 4) data.escuadra.push(user)
    } else if (emoji === 'ğŸ‘') {
      if (data.suplentes.length < 4) data.suplentes.push(user)
    } else if (emoji === 'ğŸ‘') {
      // salir ya hecho
    } else continue

    await conn.sendMessage(data.chat, { delete: msg.message.reactionMessage.key })

    let nuevoTexto = generarVersus(data.escuadra, data.suplentes)
    let sent = await conn.sendMessage(data.chat, {
      text: nuevoTexto,
      mentions: [...data.escuadra, ...data.suplentes]
    })

    delete versusData[msgID]
    versusData[sent.key.id] = data
  }
})